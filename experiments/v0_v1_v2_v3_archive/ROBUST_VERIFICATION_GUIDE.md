# Robust CV Verification Guide

## æ¦‚è¿°

æœ¬æ–‡æ¡£ä»‹ç» AR æµ‹è¯•æ¡†æ¶ä¸­çš„ä¸‰æ­¥é²æ£’ CV éªŒè¯æ”¹è¿›æ–¹æ¡ˆï¼Œæ—¨åœ¨æ˜¾è‘—é™ä½ False Positive ç‡ã€‚

## ä¸‰æ­¥æ”¹è¿›æ–¹æ¡ˆ

### âœ… æ­¥éª¤ 1: ç›¸æœºè¿åŠ¨è¡¥å¿ (Camera Motion Compensation)

**é—®é¢˜**: ç§»åŠ¨è®¾å¤‡çš„è½»å¾®æŠ–åŠ¨ï¼ˆ1-3åƒç´ ï¼‰å¯¼è‡´å…¨å±€åƒç´ é”™ä½ï¼Œè¢«è¯¯åˆ¤ä¸ºæ“ä½œæ•ˆæœã€‚

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨ OpenCV ECC ç®—æ³•å¯¹é½å‰åå¸§ï¼Œæ¶ˆé™¤å‡ ä½•è¯¯å·®ã€‚

**æ•ˆæœ**:
- æ˜¾è‘—é™ä½ç›¸æœºæŠ–åŠ¨å¯¼è‡´çš„ diff é¢ç§¯è†¨èƒ€
- æé«˜ SSIM ç¨³å®šæ€§
- ä¸ºåç»­å·®åˆ†æä¾›æ›´"å¹²å‡€"çš„è¾“å…¥

**ä½¿ç”¨æ–¹æ³•**:
```bash
python3 v3_two_phase_evaluation.py --mode eval \
    --input-dir ./data/run001 \
    --enable-alignment \
    --max-ssim 0.95
```

**æŠ€æœ¯ç»†èŠ‚**:
- é»˜è®¤ä½¿ç”¨ `MOTION_TRANSLATION`ï¼ˆå¹³ç§»å¯¹é½ï¼‰
- å¯é€‰ä½¿ç”¨ä¸­å¿ƒåŒºåŸŸå¯¹é½ï¼ˆæ›´ç¨³å®šï¼Œé»˜è®¤å¯ç”¨ï¼‰
- å¯¹é½å¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ°åŸå§‹å¸§

---

### âœ… æ­¥éª¤ 2: è‡ªé€‚åº”è¿é€šåŸŸè¿‡æ»¤ (Adaptive Connected-Component Filtering)

**é—®é¢˜**: AR æ¸²æŸ“äº§ç”Ÿçš„ç‚¹äº‘ã€ç½‘æ ¼ã€å™ªå£°å‘ˆç°ç¢ç‰‡åŒ–åˆ†å¸ƒï¼Œä¸çœŸå®äº¤äº’çš„è¿è´¯å˜åŒ–ç‰¹å¾ä¸åŒã€‚

**è§£å†³æ–¹æ¡ˆ**: åˆ†æå˜åŒ–åŒºåŸŸçš„ç©ºé—´åˆ†å¸ƒï¼Œè‡ªé€‚åº”è¿‡æ»¤ç¢ç‰‡åŒ–å™ªå£°ã€‚

**æ•ˆæœ**:
- æŠ‘åˆ¶ç‚¹äº‘é—ªçƒã€ç½‘æ ¼æ›´æ–°å¯¼è‡´çš„ FP
- ä¿ç•™ç‰©ä½“ç§»åŠ¨/æ—‹è½¬/ç¼©æ”¾ç­‰è¿è´¯å˜åŒ–ï¼ˆTPï¼‰
- è·¨ App æ³›åŒ–ï¼ˆä¸ä¾èµ–é¢œè‰²ã€å½¢çŠ¶ç­‰ç‰¹å®šç‰¹å¾ï¼‰

**ä½¿ç”¨æ–¹æ³•**:
```bash
python3 v3_two_phase_evaluation.py --mode eval \
    --input-dir ./data/run001 \
    --enable-cc-filter \
    --min-component-ratio 0.01 \
    --max-ssim 0.95
```

**æŠ€æœ¯ç»†èŠ‚**:
- ä»…å½“å˜åŒ–**é«˜åº¦ç¢ç‰‡åŒ–**æ—¶å¯ç”¨è¿‡æ»¤ï¼ˆé—¨æ§æœºåˆ¶ï¼‰
- ä½¿ç”¨ç›¸å¯¹é˜ˆå€¼ï¼ˆåŸºäº ROI é¢ç§¯æ¯”ä¾‹ï¼‰ï¼Œä¸æ˜¯å›ºå®šåƒç´ æ•°
- Failsafe æœºåˆ¶ï¼šè¿‡æ»¤åé¢ç§¯éª¤é™æ—¶å›é€€ï¼Œé¿å…è¯¯ä¼¤ TP

**å‚æ•°è¯´æ˜**:
- `--min-component-ratio`: æœ€å°è¿é€šåŸŸé¢ç§¯å æ¯”ï¼ˆé»˜è®¤ 1%ï¼‰
  - å°äºæ­¤é˜ˆå€¼çš„ç¢ç‰‡ä¼šè¢«è¿‡æ»¤
  - å€¼è¶Šå¤§ï¼Œè¿‡æ»¤è¶Šæ¿€è¿›

---

### ğŸ”„ æ­¥éª¤ 3: æ—¶åºä¸€è‡´æ€§çº¦æŸ (Temporal Consistency)

**é—®é¢˜**: ç¬æ—¶é—ªçƒã€æ›å…‰è°ƒæ•´ã€æ¸²æŸ“ jitter åœ¨å•å¸§ä¸­å‡ºç°ï¼Œä½†ä¸å…·æœ‰æ—¶é—´ç¨³å®šæ€§ã€‚

**è§£å†³æ–¹æ¡ˆ**: é‡‡é›†å¤šå¸§ post å¸§ï¼ˆå¦‚ 5 å¸§ï¼‰ï¼Œé€šè¿‡å¤šæ•°æŠ•ç¥¨æˆ–ä¸­ä½æ•°èåˆéªŒè¯ã€‚

**æ•ˆæœ**:
- æŠ‘åˆ¶çŸ­æš‚æ¸²æŸ“å™ªå£°
- æé«˜åˆ¤å®šçš„æ—¶é—´ç¨³å®šæ€§
- å¯¹çœŸå®äº¤äº’å½±å“å°ï¼ˆæŒç»­å˜åŒ–ï¼‰

**çŠ¶æ€**: ğŸš§ **éœ€è¦ä¿®æ”¹ Phase 1 æ•°æ®æ”¶é›†**

**å®ç°æ–¹æ¡ˆ**:

#### æ–¹æ¡ˆ A: å¤šæ•°æŠ•ç¥¨ (Majority Vote)
```python
# é‡‡é›† 5 å¸§ postï¼Œè‡³å°‘ 3 å¸§æ˜¾ç¤ºå˜åŒ–æ‰åˆ¤å®šä¸ºçœŸ
votes = [verify(pre, post_i) for post_i in [post1, post2, post3, post4, post5]]
verified = sum(votes) >= 3
```

#### æ–¹æ¡ˆ B: ä¸­ä½æ•°èåˆ (Median Fusion)
```python
# å¯¹ 5 å¸§å–ä¸­ä½æ•°ï¼Œç”Ÿæˆç¨³å®šçš„ post å¸§å†éªŒè¯
median_post = np.median([post1, post2, post3, post4, post5], axis=0)
verified = verify(pre, median_post)
```

**å¦‚ä½•å¯ç”¨** (å¾…å®ç°):
1. ä¿®æ”¹ Phase 1 `phase1_collect()`:
   ```python
   # æ“ä½œåé‡‡é›† 5 å¸§
   post_frames = []
   for k in range(5):
       time.sleep(0.1)  # é—´éš” 100ms
       post_k = capture_bgr(drv)
       post_frames.append(post_k)
       cv2.imwrite(f"op_{i:03d}_post_{k}.png", post_k)
   ```

2. Phase 2 æ”¯æŒå·²å®ç°ï¼ˆåœ¨ `robust_verifier.py` ä¸­ï¼‰:
   ```python
   verify_temporal_consistency(
       pre_frame=pre_bgr,
       post_frames=[post1, post2, post3, post4, post5],
       verify_fn=lambda pre, post: verify_robust(pre, post, ...),
       strategy='majority_vote',
       min_consistent_frames=3
   )
   ```

---

## ç»¼åˆä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯ 1: åŸºç¡€è¯„ä¼°ï¼ˆæ— å¢å¼ºï¼‰
```bash
python3 v3_two_phase_evaluation.py --mode eval \
    --input-dir ./data/run001 \
    --cv-method ssim \
    --max-ssim 0.95
```

### åœºæ™¯ 2: å¯ç”¨ç›¸æœºè¿åŠ¨è¡¥å¿
é€‚ç”¨äºï¼šæ‰‹æŒè®¾å¤‡æµ‹è¯•ã€ç›¸æœºæŠ–åŠ¨æ˜æ˜¾çš„åœºæ™¯

```bash
python3 v3_two_phase_evaluation.py --mode eval \
    --input-dir ./data/run001 \
    --cv-method hybrid \
    --max-ssim 0.95 \
    --enable-alignment
```

### åœºæ™¯ 3: å¯ç”¨è¿é€šåŸŸè¿‡æ»¤
é€‚ç”¨äºï¼šç‚¹äº‘/ç½‘æ ¼å¯è§†åŒ–æ˜æ˜¾ã€FP ä¸»è¦æ¥è‡ªç¢ç‰‡åŒ–å™ªå£°

```bash
python3 v3_two_phase_evaluation.py --mode eval \
    --input-dir ./data/run001 \
    --cv-method hybrid \
    --max-ssim 0.95 \
    --enable-cc-filter \
    --min-component-ratio 0.01
```

### åœºæ™¯ 4: å…¨é¢å¢å¼ºï¼ˆæ¨èï¼‰
åŒæ—¶å¯ç”¨æ­¥éª¤ 1 å’Œ 2ï¼š

```bash
python3 v3_two_phase_evaluation.py --mode eval \
    --input-dir ./data/run001 \
    --cv-method hybrid \
    --max-ssim 0.95 \
    --min-change-ratio 0.01 \
    --enable-alignment \
    --enable-cc-filter \
    --min-component-ratio 0.01
```

---

## å‚æ•°è°ƒä¼˜æŒ‡å—

### SSIM é˜ˆå€¼ (`--max-ssim`)
- **é»˜è®¤**: 0.95
- **è°ƒä½** (å¦‚ 0.90): æ›´æ•æ„Ÿï¼Œå¯èƒ½å¢åŠ  FP
- **è°ƒé«˜** (å¦‚ 0.98): æ›´ä¿å®ˆï¼Œå¯èƒ½å¢åŠ  FN
- **å»ºè®®**: æ ¹æ®åŸºå‡†æµ‹è¯•ç»“æœè°ƒæ•´
  - è§‚å¯Ÿ TP æ“ä½œçš„ SSIM èŒƒå›´ï¼ˆå¦‚ 0.82-0.88ï¼‰
  - è§‚å¯Ÿ TN æ“ä½œçš„ SSIM èŒƒå›´ï¼ˆå¦‚ 0.90-0.97ï¼‰
  - é€‰æ‹©ä¸­é—´å€¼ï¼ˆå¦‚ 0.95ï¼‰

### åƒç´ å˜åŒ–ç‡ (`--min-change-ratio`)
- **é»˜è®¤**: 0.01 (1%)
- **è°ƒé«˜** (å¦‚ 0.05): é™ä½ FPï¼Œå¯èƒ½å¢åŠ  FN
- **è°ƒä½** (å¦‚ 0.005): æé«˜å¬å›ç‡ï¼Œå¯èƒ½å¢åŠ  FP

### è¿é€šåŸŸæœ€å°æ¯”ä¾‹ (`--min-component-ratio`)
- **é»˜è®¤**: 0.01 (1% of ROI)
- **è°ƒé«˜** (å¦‚ 0.02): æ›´æ¿€è¿›è¿‡æ»¤ï¼Œé™ä½ FP
- **è°ƒä½** (å¦‚ 0.005): ä¿å®ˆè¿‡æ»¤ï¼Œä¿æŠ¤ TP

---

## é¢„æœŸæ•ˆæœ

åŸºäº AR æµ‹è¯•åœºæ™¯çš„å…¸å‹æ”¹è¿›ï¼š

| æ”¹è¿›æ­¥éª¤ | FP é™ä½ | FN å½±å“ | é€‚ç”¨åœºæ™¯ |
|---------|---------|---------|---------|
| ç›¸æœºè¿åŠ¨è¡¥å¿ | 10-20% | æå° | æ‰€æœ‰åœºæ™¯ |
| è¿é€šåŸŸè¿‡æ»¤ | 15-30% | <5% | ç‚¹äº‘/ç½‘æ ¼å¯è§†åŒ– |
| æ—¶åºä¸€è‡´æ€§ | 20-40% | <10% | é—ªçƒ/æ›å…‰å˜åŒ– |
| **ç»¼åˆä½¿ç”¨** | **40-60%** | **<15%** | æ¨è |

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: Alignment å¤±è´¥ç‡é«˜
```
debug_info['alignment']['success'] = False (å¤šæ¬¡å‡ºç°)
```

**åŸå› **: åœºæ™¯çº¹ç†ä¸è¶³ï¼ˆç™½å¢™ã€çº¯è‰²èƒŒæ™¯ï¼‰

**è§£å†³æ–¹æ¡ˆ**:
- ç¦ç”¨ alignment: ä¸ä½¿ç”¨ `--enable-alignment`
- æˆ–ä»…åœ¨çº¹ç†ä¸°å¯Œçš„åœºæ™¯ä½¿ç”¨

### é—®é¢˜ 2: CC è¿‡æ»¤è¯¯ä¼¤ TP
```
TP æ“ä½œè¢«åˆ¤å®šä¸º FN (Failsafe æœªè§¦å‘)
```

**åŸå› **: `min_component_ratio` è®¾ç½®è¿‡å¤§

**è§£å†³æ–¹æ¡ˆ**:
- é™ä½é˜ˆå€¼: `--min-component-ratio 0.005`
- æ£€æŸ¥ debug_info ä¸­çš„ `filtered_area` vs `total_area`

### é—®é¢˜ 3: ç»¼åˆä½¿ç”¨å Recall ä¸‹é™æ˜æ˜¾
```
FN å¢åŠ  >20%
```

**åŸå› **: å¤šä¸ªæ­¥éª¤çš„ä¿å®ˆç­–ç•¥å åŠ 

**è§£å†³æ–¹æ¡ˆ**:
- åªå¯ç”¨å…¶ä¸­ä¸€ä¸ªæ­¥éª¤æµ‹è¯•æ•ˆæœ
- è°ƒæ•´é˜ˆå€¼ï¼ˆé™ä½ `max_ssim` æˆ– `min_component_ratio`ï¼‰

---

## æŠ€æœ¯æ¶æ„

### æ¨¡å—ç»„ç»‡
```
src/verifier/backends/
â”œâ”€â”€ ssim_verifier.py          # åŸºç¡€ SSIM éªŒè¯ï¼ˆæ­¥éª¤ 0ï¼‰
â””â”€â”€ robust_verifier.py         # ä¸‰æ­¥é²æ£’éªŒè¯

experiments/v0_v1_v2_v3_archive/
â””â”€â”€ v3_two_phase_evaluation.py # é›†æˆè°ƒç”¨
```

### å‡½æ•°æ¥å£
```python
# robust_verifier.py
verify_robust(
    pre_bgr, post_bgr,
    enable_alignment=True,      # æ­¥éª¤ 1
    enable_cc_filter=True,      # æ­¥éª¤ 2
    post_frames=None,           # æ­¥éª¤ 3 (å¯é€‰)
    max_ssim=0.95,
    return_debug_info=True      # è·å–è¯¦ç»†è¯Šæ–­ä¿¡æ¯
)
```

---

## ä¸‹ä¸€æ­¥è®¡åˆ’

1. âœ… å®ç°æ­¥éª¤ 1: ç›¸æœºè¿åŠ¨è¡¥å¿
2. âœ… å®ç°æ­¥éª¤ 2: è¿é€šåŸŸè¿‡æ»¤
3. ğŸ”„ å®ç°æ­¥éª¤ 3: æ—¶åºä¸€è‡´æ€§ï¼ˆéœ€ä¿®æ”¹ Phase 1ï¼‰
4. ğŸ“Š åœ¨çœŸå®æ•°æ®é›†ä¸Šè¯„ä¼°æ”¹è¿›æ•ˆæœ
5. ğŸ“ æ’°å†™å®Œæ•´çš„æŠ€æœ¯æŠ¥å‘Š

---

## å‚è€ƒæ–‡çŒ®

- OpenCV ECC Image Alignment
- Connected Component Analysis
- Temporal Consistency in Video Processing
